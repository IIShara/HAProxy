# HAProxy
Раздел global определяет общую конфигурацию для всего HAProxy
```
global
    log         127.0.0.1 local2      # Необходимо установить /etc/rsyslog.conf плюс уровень ведения журнала и путь журнала для устройства local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000                  # Это максимальное количество внешних подключений в предыдущем сегменте. При проксировании http нет большой проблемы с 1 ГБ свободной памяти, содержащей более 20000
    user        haproxy
    group       haproxy
    daemon
    stats socket /var/lib/haproxy/stats  # Включите динамический просмотр и управление файлами статуса haproxy
                                         # Кроме того, рекомендуется установить глобальный элемент проверки распространения, а процентное соотношение рекомендуется в диапазоне 2-5
```
Defaults определяет настройки по-умолчанию для остальных разделов проксирования
```
defaults
    mode                    http         # 7 уровней прокси http и 4 уровня прокси tcp
    log                     global
    option                  httplog      # Записывать http-запрос, информацию о сеансе и т. Д. В журнал
    option                  dontlognull  # Не записывать пустые соединения в журнал
    option http-server-close             # Рекомендуется использовать http-server-close для динамических приложений на бэкэнде и http-keep-alive для статических приложений на бэкэнде
    option forwardfor       except 127.0.0.0/8  # haproxy добавит поле заголовка «X-Forwarded-For» в запрос, отправленный на бэкэнд
    option                  redispatch   # Когда бэкэнд не работает, так что haproxy не может пересылать запросы, несущие куки, в этот бэкэнд, перенаправить их другим бэкэндам
    timeout http-request    10s     # Это максимальное время ожидания, пока клиент отправит полный запрос, его следует установить короче, чтобы предотвратить атаки флуда, например, 2-3 секунды
                                    # haproxy всегда требует, чтобы запрос или ответ были обработаны и перенаправлены после отправки,
    timeout queue           1m      # Максимальная продолжительность запроса в очереди, 1 минута слишком велика. Установка 10 секунд - это немного долго, и клиент потеряет терпение, если ресурс не будет запрошен в течение 10 секунд.
    timeout connect         10s     # haproxy Максимальное время для установления соединения с сервером, равное 1 секунде, достаточно. Установление соединения в локальной сети обычно происходит мгновенно.
    timeout client          1m      # Период тайм-аута для поддержания незанятого соединения с клиентом может быть немного короче при высоком уровне параллелизма и может быть установлен на 10 секунд, чтобы разорвать соединение как можно скорее
    timeout server          1m      # Период тайм-аута для поддержания неактивного соединения с сервером, соединение устанавливается быстро в локальной сети, поэтому постарайтесь установить его как можно короче, особенно когда оно одновременное, например, 1-3 секунды.
    timeout http-keep-alive 10s     # Максимальное время поддержания длительного соединения с клиентом. Приоритет выше таймаута http-запроса выше таймаута клиента
    timeout check           10s     # Продолжительность времени от успешного установления соединения с внутренним сервером до окончательного завершения проверки (не включая время для установления соединения, только время, чтобы прочитать результат проверки),
                                    # Можно установить короче, например 1-2 секунды
    maxconn                 3000    # Максимальное количество соединений между сегментом по умолчанию и предыдущим, но не может превышать жесткое ограничение maxconn в глобальном
```
Раздел listen объединяет в себе описание для фронтенда и бэкенда и содержит полный список прокси. Он полезен для TCP трафика.
```
 listen stats-srv-3.my.com *:8180   #описание IP: порта доступа к статистике
stats uri /stats                    # URL доступа к статистеке
stats realm Haproxy\ Statistics     #титл странички статистики
stats show-legends                  #отобразать в статистеке дополнительную информацию о параметрах
stats refresh 5s                    # интервал автоматического обнавления странички статистики
maxconn 300
mode http
option httpclose
transparent
stats auth test:test                #логин и пароль для доступа к статистике
clitimeout 10000
srvtimeout 10000
contimeout 4000
```
Раздел Frontend определяет, каким образом перенаправлять запросы к бэкенду в зависимости от того, что за запрос поступил от клиента.
```
 frontend haproxy
  mode http                         #Тип распределения нагрузки. Если указать http, HAProxy станет работать на прикладном уровне (Layer 7)
  bind *:80                         #Адрес и порт, которые HAProxy должен слушать «на входе»
  default_backend http-backend      #Название конфигурации группы серверов, к которым надо направить запрос для обработки. В данном случае запросы пойдут к backend с названием http-backend
```
Секция Backend содержит список серверов и отвечает за балансировку нагрузки между ними в зависимости от выбранного алгоритма
```
backend http-backend                #указываем список нод или серверов, на которые пересылаем
  mode http
  fullconn 200                      # максимальное значение одновременных конектов
  stats enable                      #включить статистику
  balance roundrobin                #делать авто баланс между несколькими нодами в рамках этого backend 
    server srv1 luna-1:80 check
    server srv2 luna-2:80 check
```
# Алгоритмы балансировки

# Roundrobin
Первый в списке и самый простой алгоритм — Round Robin. Включается записью balance roundrobin в секции backend. С этой опцией HAProxy будет перебирать сервера по очереди и равномерно покрывать нагрузкой вашу «ферму». Пример конфигурации:
```
backend
    balance roundrobin
        server srv1 luna-1:80
        server srv2 luna-2:80
```
Если к серверам добавить параметр weight, то получится более продвинутая версия алгоритма — weighted roundrobin:
```
backend
    balance roundrobin
        server srv1 luna-1:80 weight 2
        server srv2 luna-2:80 weight 1
```
Благодаря разным значением весов, балансировщик будет распределять нагрузку исходя из физических возможностей серверов. И сервер с параметром weight 2 из примера выше будет получать в 2 раза больше запросов, чем с параметром weight 1
# Least Connections
Алгоритм с названием «Least connections» учитывает количество подключений на серверах. Таким образом, каждый следующий запрос передаётся серверу с наименьшим количеством активных подключений. Включить алгоритм можно с помощью опции «balance leastconn» в секции backend.
```
backend
    balance leastconn
        server srv1 luna-1:80
        server srv2 luna-2:80
```
